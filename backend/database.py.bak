import os
import logging
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker, declarative_base
from sqlalchemy.engine.url import make_url
from sqlalchemy.exc import OperationalError

logger = logging.getLogger("database")

# ============================================================
# 1. LER E VALIDAR A DATABASE_URL
# ============================================================

DATABASE_URL = os.getenv("DATABASE_URL", "").strip()

if not DATABASE_URL:
    raise RuntimeError(
        "❌ ERRO: A variável de ambiente DATABASE_URL não está definida.\n"
        "No Render: vá em ➜ Backend Service ➜ Environment ➜ Add Env Var.\n"
        "Cole exatamente a connection string do banco (postgres://...)."
    )

# Corrigir automaticamente o prefixo postgres:// ➜ postgresql+psycopg2://
if DATABASE_URL.startswith("postgres://"):
    DATABASE_URL = DATABASE_URL.replace("postgres://", "postgresql+psycopg2://", 1)

# Testar se a URL é válida
try:
    make_url(DATABASE_URL)
except Exception as e:
    masked = DATABASE_URL[:40] + "..." if len(DATABASE_URL) > 40 else DATABASE_URL
    raise RuntimeError(
        f"❌ DATABASE_URL inválida: {masked}\n"
        f"Motivo: {e}\n"
        "Verifique se a URL está completa e sem aspas extras."
    )

# ============================================================
# 2. CRIAR ENGINE (com pool_pre_ping para Render)
# ============================================================

try:
    engine = create_engine(
        DATABASE_URL,
        pool_pre_ping=True,
        future=True,
    )
except Exception as e:
    raise RuntimeError(f"❌ Falha ao criar engine do SQLAlchemy: {e}")

# ============================================================
# 3. SESSION + BASE
# ============================================================

SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine,
    future=True,
)

Base = declarative_base()

# ============================================================
# 4. DEPENDÊNCIA PARA FASTAPI
# ============================================================

def get_db():
    """Sessão padrão para FastAPI"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# ============================================================
# 5. Função utilitária EXECUTE_QUERY (usada pela IA e outros)
# ============================================================

def execute_query(query: str, params: dict | None = None, fetch: bool = False):
    """
    Executa SQL RAW no banco quando necessário.

    Ex:
        execute_query("SELECT * FROM alunos WHERE id=:id", {"id": 1}, fetch=True)
    """
    try:
        with engine.connect() as conn:
            result = conn.execute(text(query), params or {})
            if fetch:
                rows = result.mappings().all()
                return [dict(row) for row in rows]
            conn.commit()
            return True
    except OperationalError as e:
        logger.error(f"❌ Erro ao executar query: {e}")
        raise
